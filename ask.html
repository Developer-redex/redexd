<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³Ø£Ù„ Ø®Ø¨ÙŠØ±Ø§Ù‹ - Redex</title>
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    <link rel="stylesheet" href="../styles/globals.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/toast.css">
</head>

<body>
    <header class="header" id="header">
        <div class="container">
            <a href="../index.html" class="logo">
                <div class="logo-icon">R</div>
                <span>Redex</span>
            </a>

            <nav class="nav">
                <ul class="nav-links">
                    <li><a href="../index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="projects.html" class="nav-link">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</a></li>
                    <li><a href="ask.html" class="nav-link active">Ø§Ø³Ø£Ù„ Ø®Ø¨ÙŠØ±Ø§Ù‹</a></li>
                </ul>

                <div class="nav-buttons">
                    <button class="btn btn-secondary btn-sm" onclick="toggleTheme()">ğŸŒ—</button>
                    <!-- Auth state -->
                </div>
            </nav>
        </div>
    </header>

    <div class="container" style="margin-top: 4rem; max-width: 800px;">
        <h1 class="section-title">Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø©</h1>

        <!-- Ask Form -->
        <div class="card mb-xl">
            <h3>Ù„Ø¯ÙŠÙƒ Ø³Ø¤Ø§Ù„ ØªÙ‚Ù†ÙŠØŸ</h3>
            <form id="ask-form">
                <div class="mb-md">
                    <input type="text" id="question-title" class="input-field mb-sm" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„"
                        required>
                    <textarea id="question-body" class="input-field" rows="3" placeholder="Ø§Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."
                        required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </form>
        </div>

        <!-- Questions List -->
        <div id="questions-list">
            <!-- Loaded dynamically -->
        </div>
    </div>

    <script src="../scripts/api.js"></script>
    <script src="../scripts/main.js"></script>
    <script>
        document.getElementById('ask-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentUser = getFromLocalStorage('currentUser');
            if (!currentUser) {
                showToast('ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„!', 'warning');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            const title = document.getElementById('question-title').value;
            const body = document.getElementById('question-body').value;

            const question = {
                id: Date.now(),
                author: currentUser.username,
                avatar: currentUser.avatar,
                title,
                body,
                date: new Date().toISOString(),
                replies: []
            };

            try {
                await DataService.addQuestion(question);
                showToast('ØªÙ… Ù†Ø´Ø± Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                renderQuestions();
                e.target.reset();
            } catch (err) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
            }
        });

        async function renderQuestions() {
            const container = document.getElementById('questions-list');
            const currentUser = getFromLocalStorage('currentUser');

            try {
                const questions = await DataService.getQuestions();

                if (questions.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯. ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!</p>';
                    return;
                }

                container.innerHTML = questions.map(q => `
                    <div class="card mb-md">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <img src="${q.avatar || '../assets/favicon.svg'}" style="width: 40px; height: 40px; border-radius: 50%;">
                            <div>
                                <h4 style="margin: 0;">${q.author}</h4>
                                <span class="text-muted text-sm">${new Date(q.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--color-primary);">${q.title}</h3>
                        <p style="margin-bottom: 1.5rem;">${q.body}</p>
                        
                        <div style="background: var(--color-bg-body); padding: 1rem; border-radius: var(--border-radius-sm);">
                            <h4 style="margin-bottom: 0.5rem;">Ø§Ù„Ø±Ø¯ÙˆØ¯ (${q.replies.length})</h4>
                            ${q.replies.map(r => `
                                <div style="border-bottom: 1px solid var(--color-border); padding: 0.5rem 0;">
                                    <strong>${r.author}:</strong> ${r.text}
                                </div>
                            `).join('')}
                            
                            ${currentUser ? `
                                <form onsubmit="addReply(event, ${q.id})" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <input type="text" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ø§Ù‹..." required style="padding: 0.5rem;">
                                    <button class="btn btn-secondary btn-sm">Ø±Ø¯</button>
                                </form>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<p class="text-center text-error">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>';
            }
        }

        // Global definition so HTML strings can access it
        window.addReply = async function (e, questionId) {
            e.preventDefault();
            const input = e.target.querySelector('input');
            const text = input.value;
            const currentUser = getFromLocalStorage('currentUser');

            if (!currentUser) return;

            try {
                await DataService.replyToQuestion(questionId, {
                    author: currentUser.username,
                    text: text,
                    date: new Date().toISOString()
                });
                renderQuestions();
            } catch (err) {
                showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯', 'error');
            }
        };

        // Initial Load
        renderQuestions();
    </script>
    <script>
        // Real-time Sync
        window.addEventListener('storage', (e) => {
            if (e.key === 'redex_questions') {
                renderQuestions();
                showToast('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'info', 2000);
            }
        });
    </script>
</body>

</html>